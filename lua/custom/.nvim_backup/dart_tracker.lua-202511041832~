-- COSC 60 25F Final Project
-- Ben Cavanagh, Josh Meise
--
-- Keystroke tracker for dart collaborative
-- editor. Converts all nvim buffer updates
-- into logs with start/end coords and text
-- of the edits.
--

-- Lua module to be places in ~/.config/nvim/lua/custom
-- With lazy.nvim configuration can call directly using
-- :lua require("custom.dart_tracker").start()
M = {}
UPDATES = {}

function M.log_updates(buffer)
  -- "false" next line for api func: do we return the entire starting buffer?
  vim.api.nvim_buf_attach(buffer, false, {
    on_bytes = function(_, buffer, tick, srow, scol, _, oerow, oecol, _, nerow, necol, _)
      vim.schedule(function()
        -- Store changes as string and table
        change = {CURRFILE, tick, srow, scol, oerow, oecol, nerow, necol}
        ch_str = string.format("file=%s, tick=%d srow=%d scol=%d oerow=%d oecol=%d nerow=%d necol=%d",
          CURRFILE, tick, srow, scol, oerow, oecol, nerow, necol)

        -- Grab text of change
        local ch_txt = ""
        -- Multi-line or multi-column edits
        if (nerow > srow or (nerow == srow and necol > scol)) then
          local text = vim.api.nvim_buf_get_text(buffer, srow, scol, nerow, necol, {})
          if text then
            ch_txt = table.concat(text, "\n")
          end
        else
        -- Single char edits
          -- false here b/c don't want to produce error with out-of-bounds
          local text = vim.api.nvim_buf_get_lines( buffer, srow, srow + 1, false)
          if (#text> 0 and scol < #text[1]) then
            ch_txt = text[1]:sub(scol + 1, scol + 1)
          end
        end

        -- Write to table and file
        table.insert(UPDATES, change)
        local path = vim.fn.expand("./dartlog.txt")
        local changelog = io.open(path, "a")
        if changelog ~= nil then
          changelog:write(ch_str, " text=", ch_txt, "\n")
          changelog:close()
        else
          vim.notify("failed to open changelog")
        end

      end)
    end
  })
end


function M.start()
  vim.notify("TRACKING CHANGES")
  CURRFILE = vim.fn.expand("%:t") -- Remove path for now with :t
  local currbuff = vim.api.nvim_get_current_buf()
  M.log_updates(currbuff)
end

return M
