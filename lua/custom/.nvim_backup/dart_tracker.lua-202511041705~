-- COSC 60 25F Final Project
-- Ben Cavanagh, Josh Meise
--
-- Keystroke tracker for dart collaborative
-- editor. Converts all nvim keystrokes into
-- "insert" "delete" or "replace" edits.
--

UPDATES = {}

function UPDATES.log_updates(buffer)
  local send = false -- Should we return the entire starting buffer?
  vim.api.nvim_buf_attach(buffer, send, {
    on_bytes = function(_, _, tick, srow, scol, _, oerow, oecol, _, nerow, necol, _)
      -- get the new text that now occupies the changed region
      local ok, new_text = pcall(function()
        return table.concat(vim.api.nvim_buf_get_text(buf, srow, scol, nerow, necol, {}), "\n")
      end)

      local changelog = io.open(vim.fn.expand("~/dartmouth/classes/cosc60-final/dartlog.txt"), "a")
      if changelog ~= nil then
        changelog:write(string.format(
          "tick=%d srow=%d scol=%d oerow=%d oecol=%d nerow=%d necol=%d text=%s\n",
          tick, srow, scol, oerow, oecol, nerow, necol, ok and vim.fn.shellescape(new_text) or "<error>"
        ))
        changelog:close()
      else
        vim.notify("failed to open changelog")
      end
    end
  })
end


function UPDATES.start()
  vim.notify("TRACKING CHANGES")
  UPDATES.log_updates(vim.api.nvim_get_current_buf())
end

return UPDATES
