-- ~/.config/nvim/lua/custom/change_logger.lua

local M = {}

local log_dir = vim.fn.expand '~/.local/share/nvim'
vim.fn.mkdir(log_dir, 'p')
local log_file = log_dir .. '/change_log.txt'

local function log_change(change)
  local f, err = io.open(log_file, 'a')
  if not f then
    vim.notify('Failed to open log file: ' .. tostring(err), vim.log.levels.ERROR)
    return
  end
  f:write(vim.inspect(change) .. '\n')
  f:close()
end

function M.attach(bufnr)
  vim.api.nvim_buf_attach(bufnr or 0, false, {
    on_lines = function(_, buf, tick, first, last, new_last)
      local lines = vim.api.nvim_buf_get_lines(buf, first, new_last, false)
      log_change {
        tick = tick,
        start = first,
        old_end = last,
        new_end = new_last,
        new_text = lines,
      }
    end,
  })
end

return M
